/**
 * Minified by jsDelivr using Terser v5.39.0.
 * Original file: /npm/dockview-core@4.7.1/dist/esm/dockview/dockviewComponent.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{getRelativeLocation,getGridLocation,orthogonal}from"../gridview/gridview";import{directionToPosition,Droptarget}from"../dnd/droptarget";import{tail,sequenceEquals,remove}from"../array";import{DockviewPanel}from"./dockviewPanel";import{CompositeDisposable,Disposable}from"../lifecycle";import{Event,Emitter,addDisposableListener}from"../events";import{Watermark}from"./components/watermark/watermark";import{sequentialNumberGenerator}from"../math";import{DefaultDockviewDeserialzier}from"./deserializer";import{DockviewUnhandledDragOverEvent,isGroupOptionsWithGroup,isGroupOptionsWithPanel,isPanelOptionsWithGroup,isPanelOptionsWithPanel}from"./options";import{BaseGrid,toTarget}from"../gridview/baseComponentGridview";import{DockviewApi}from"../api/component.api";import{Orientation}from"../splitview/splitview";import{DockviewDidDropEvent,DockviewWillDropEvent}from"./dockviewGroupPanelModel";import{WillShowOverlayLocationEvent}from"./events";import{DockviewGroupPanel}from"./dockviewGroupPanel";import{DockviewPanelModel}from"./dockviewPanelModel";import{getPanelData}from"../dnd/dataTransfer";import{Overlay}from"../overlay/overlay";import{addTestId,Classnames,getDockviewTheme,onDidWindowResizeEnd,onDidWindowMoveEnd,toggleClass,watchElementResize}from"../dom";import{DockviewFloatingGroupPanel}from"./dockviewFloatingGroupPanel";import{DEFAULT_FLOATING_GROUP_OVERFLOW_SIZE,DEFAULT_FLOATING_GROUP_POSITION,DESERIALIZATION_POPOUT_DELAY_MS}from"../constants";import{OverlayRenderContainer}from"../overlay/overlayRenderContainer";import{PopoutWindow}from"../popoutWindow";import{StrictEventsSequencing}from"./strictEventsSequencing";import{PopupService}from"./components/popupService";import{DropTargetAnchorContainer}from"../dnd/dropTargetAnchorContainer";import{themeAbyss}from"./theme";const DEFAULT_ROOT_OVERLAY_MODEL={activationSize:{type:"pixels",value:10},size:{type:"pixels",value:20}};function moveGroupWithoutDestroying(e){const i=e.from.activePanel;[...e.from.panels].map((i=>{const o=e.from.model.removePanel(i);return e.from.model.renderContainer.detatch(i),o})).forEach((o=>{e.to.model.openPanel(o,{skipSetActive:i!==o,skipSetGroupActive:!0})}))}export class DockviewComponent extends BaseGrid{get orientation(){return this.gridview.orientation}get totalPanels(){return this.panels.length}get panels(){return this.groups.flatMap((e=>e.panels))}get options(){return this._options}get activePanel(){const e=this.activeGroup;if(e)return e.activePanel}get renderer(){var e;return null!==(e=this.options.defaultRenderer)&&void 0!==e?e:"onlyWhenVisible"}get api(){return this._api}get floatingGroups(){return this._floatingGroups}get popoutRestorationPromise(){return this._popoutRestorationPromise}constructor(e,i){var o,t,n;super(e,{proportionalLayout:!0,orientation:Orientation.HORIZONTAL,styles:i.hideBorders?{separatorBorder:"transparent"}:void 0,disableAutoResizing:i.disableAutoResizing,locked:i.locked,margin:null!==(t=null===(o=i.theme)||void 0===o?void 0:o.gap)&&void 0!==t?t:0,className:i.className}),this.nextGroupId=sequentialNumberGenerator(),this._deserializer=new DefaultDockviewDeserialzier(this),this._watermark=null,this._onWillDragPanel=new Emitter,this.onWillDragPanel=this._onWillDragPanel.event,this._onWillDragGroup=new Emitter,this.onWillDragGroup=this._onWillDragGroup.event,this._onDidDrop=new Emitter,this.onDidDrop=this._onDidDrop.event,this._onWillDrop=new Emitter,this.onWillDrop=this._onWillDrop.event,this._onWillShowOverlay=new Emitter,this.onWillShowOverlay=this._onWillShowOverlay.event,this._onUnhandledDragOverEvent=new Emitter,this.onUnhandledDragOverEvent=this._onUnhandledDragOverEvent.event,this._onDidRemovePanel=new Emitter,this.onDidRemovePanel=this._onDidRemovePanel.event,this._onDidAddPanel=new Emitter,this.onDidAddPanel=this._onDidAddPanel.event,this._onDidPopoutGroupSizeChange=new Emitter,this.onDidPopoutGroupSizeChange=this._onDidPopoutGroupSizeChange.event,this._onDidPopoutGroupPositionChange=new Emitter,this.onDidPopoutGroupPositionChange=this._onDidPopoutGroupPositionChange.event,this._onDidOpenPopoutWindowFail=new Emitter,this.onDidOpenPopoutWindowFail=this._onDidOpenPopoutWindowFail.event,this._onDidLayoutFromJSON=new Emitter,this.onDidLayoutFromJSON=this._onDidLayoutFromJSON.event,this._onDidActivePanelChange=new Emitter({replay:!0}),this.onDidActivePanelChange=this._onDidActivePanelChange.event,this._onDidMovePanel=new Emitter,this.onDidMovePanel=this._onDidMovePanel.event,this._onDidMaximizedGroupChange=new Emitter,this.onDidMaximizedGroupChange=this._onDidMaximizedGroupChange.event,this._floatingGroups=[],this._popoutGroups=[],this._popoutRestorationPromise=Promise.resolve(),this._onDidRemoveGroup=new Emitter,this.onDidRemoveGroup=this._onDidRemoveGroup.event,this._onDidAddGroup=new Emitter,this.onDidAddGroup=this._onDidAddGroup.event,this._onDidOptionsChange=new Emitter,this.onDidOptionsChange=this._onDidOptionsChange.event,this._onDidActiveGroupChange=new Emitter,this.onDidActiveGroupChange=this._onDidActiveGroupChange.event,this._moving=!1,this._options=i,this.popupService=new PopupService(this.element),this._themeClassnames=new Classnames(this.element),this._api=new DockviewApi(this),this.rootDropTargetContainer=new DropTargetAnchorContainer(this.element,{disabled:!0}),this.overlayRenderContainer=new OverlayRenderContainer(this.gridview.element,this),this._rootDropTarget=new Droptarget(this.element,{className:"dv-drop-target-edge",canDisplayOverlay:(e,i)=>{const o=getPanelData();if(o)return o.viewId===this.id&&("center"!==i||0===this.gridview.length);if("center"===i&&0!==this.gridview.length)return!1;const t=new DockviewUnhandledDragOverEvent(e,"edge",i,getPanelData);return this._onUnhandledDragOverEvent.fire(t),t.isAccepted},acceptedTargetZones:["top","bottom","left","right","center"],overlayModel:null!==(n=i.rootOverlayModel)&&void 0!==n?n:DEFAULT_ROOT_OVERLAY_MODEL,getOverrideTarget:()=>{var e;return null===(e=this.rootDropTargetContainer)||void 0===e?void 0:e.model}}),this.updateDropTargetModel(i),toggleClass(this.gridview.element,"dv-dockview",!0),toggleClass(this.element,"dv-debug",!!i.debug),this.updateTheme(),this.updateWatermark(),i.debug&&this.addDisposables(new StrictEventsSequencing(this)),this.addDisposables(this.rootDropTargetContainer,this.overlayRenderContainer,this._onWillDragPanel,this._onWillDragGroup,this._onWillShowOverlay,this._onDidActivePanelChange,this._onDidAddPanel,this._onDidRemovePanel,this._onDidLayoutFromJSON,this._onDidDrop,this._onWillDrop,this._onDidMovePanel,this._onDidAddGroup,this._onDidRemoveGroup,this._onDidActiveGroupChange,this._onUnhandledDragOverEvent,this._onDidMaximizedGroupChange,this._onDidOptionsChange,this._onDidPopoutGroupSizeChange,this._onDidPopoutGroupPositionChange,this._onDidOpenPopoutWindowFail,this.onDidViewVisibilityChangeMicroTaskQueue((()=>{this.updateWatermark()})),this.onDidAdd((e=>{this._moving||this._onDidAddGroup.fire(e)})),this.onDidRemove((e=>{this._moving||this._onDidRemoveGroup.fire(e)})),this.onDidActiveChange((e=>{this._moving||this._onDidActiveGroupChange.fire(e)})),this.onDidMaximizedChange((e=>{this._onDidMaximizedGroupChange.fire({group:e.panel,isMaximized:e.isMaximized})})),Event.any(this.onDidAdd,this.onDidRemove)((()=>{this.updateWatermark()})),Event.any(this.onDidAddPanel,this.onDidRemovePanel,this.onDidAddGroup,this.onDidRemove,this.onDidMovePanel,this.onDidActivePanelChange,this.onDidPopoutGroupPositionChange,this.onDidPopoutGroupSizeChange)((()=>{this._bufferOnDidLayoutChange.fire()})),Disposable.from((()=>{for(const e of[...this._floatingGroups])e.dispose();for(const e of[...this._popoutGroups])e.disposable.dispose()})),this._rootDropTarget,this._rootDropTarget.onWillShowOverlay((e=>{this.gridview.length>0&&"center"===e.position||this._onWillShowOverlay.fire(new WillShowOverlayLocationEvent(e,{kind:"edge",panel:void 0,api:this._api,group:void 0,getData:getPanelData}))})),this._rootDropTarget.onDrop((e=>{var i;const o=new DockviewWillDropEvent({nativeEvent:e.nativeEvent,position:e.position,panel:void 0,api:this._api,group:void 0,getData:getPanelData,kind:"edge"});if(this._onWillDrop.fire(o),o.defaultPrevented)return;const t=getPanelData();t?this.moveGroupOrPanel({from:{groupId:t.groupId,panelId:null!==(i=t.panelId)&&void 0!==i?i:void 0},to:{group:this.orthogonalize(e.position),position:"center"}}):this._onDidDrop.fire(new DockviewDidDropEvent({nativeEvent:e.nativeEvent,position:e.position,panel:void 0,api:this._api,group:void 0,getData:getPanelData}))})),this._rootDropTarget)}setVisible(e,i){switch(e.api.location.type){case"grid":super.setVisible(e,i);break;case"floating":{const o=this.floatingGroups.find((i=>i.group===e));o&&(o.overlay.setVisible(i),e.api._onDidVisibilityChange.fire({isVisible:i}));break}case"popout":console.warn("dockview: You cannot hide a group that is in a popout window")}}addPopoutGroup(e,i){var o,t,n,r,s;if(e instanceof DockviewPanel&&1===e.group.size)return this.addPopoutGroup(e.group,i);const a=getDockviewTheme(this.gridview.element),p=this.element;const d=(null==i?void 0:i.position)?i.position:e instanceof DockviewGroupPanel?e.element.getBoundingClientRect():e.group?e.group.element.getBoundingClientRect():p.getBoundingClientRect(),l=null!==(t=null===(o=null==i?void 0:i.overridePopoutGroup)||void 0===o?void 0:o.id)&&void 0!==t?t:this.getNextGroupId(),h=new PopoutWindow(`${this.id}-${l}`,null!=a?a:"",{url:null!==(s=null!==(n=null==i?void 0:i.popoutUrl)&&void 0!==n?n:null===(r=this.options)||void 0===r?void 0:r.popoutUrl)&&void 0!==s?s:"/popout.html",left:window.screenX+d.left,top:window.screenY+d.top,width:d.width,height:d.height,onDidOpen:null==i?void 0:i.onDidOpen,onWillClose:null==i?void 0:i.onWillClose}),u=new CompositeDisposable(h,h.onDidClose((()=>{u.dispose()})));return h.open().then((o=>{var t;if(h.isDisposed)return!1;const n=(null==i?void 0:i.referenceGroup)?i.referenceGroup:e instanceof DockviewPanel?e.group:e,r=e.api.location.type,s=null!==n.element.parentElement;let a;if(s?(null==i?void 0:i.overridePopoutGroup)?a=i.overridePopoutGroup:(a=this.createGroup({id:l}),o&&this._onDidAddGroup.fire(a)):a=n,null===o)return console.error("dockview: failed to create popout. perhaps you need to allow pop-ups for this website"),u.dispose(),this._onDidOpenPopoutWindowFail.fire(),this.movingLock((()=>moveGroupWithoutDestroying({from:a,to:n}))),n.api.isVisible||n.api.setVisible(!0),!1;const p=document.createElement("div");p.className="dv-overlay-render-container";const d=new OverlayRenderContainer(p,this);let v;if(a.model.renderContainer=d,a.layout(h.window.innerWidth,h.window.innerHeight),!(null==i?void 0:i.overridePopoutGroup)&&s)if(e instanceof DockviewPanel)this.movingLock((()=>{const i=n.model.removePanel(e);a.model.openPanel(i)}));else switch(this.movingLock((()=>moveGroupWithoutDestroying({from:n,to:a}))),r){case"grid":n.api.setVisible(!1);break;case"floating":case"popout":v=null===(t=this._floatingGroups.find((i=>i.group.api.id===e.api.id)))||void 0===t?void 0:t.overlay.toJSON(),this.removeGroup(n)}o.classList.add("dv-dockview"),o.style.overflow="hidden",o.appendChild(p),o.appendChild(a.element);const c=document.createElement("div"),g=new DropTargetAnchorContainer(c,{disabled:this.rootDropTargetContainer.disabled});let m;o.appendChild(c),a.model.dropTargetContainer=g,a.model.location={type:"popout",getWindow:()=>h.window,popoutUrl:null==i?void 0:i.popoutUrl},s&&"grid"===e.api.location.type&&e.api.setVisible(!1),this.doSetGroupAndPanelActive(a),u.addDisposables(a.api.onDidActiveChange((e=>{var i;e.isActive&&(null===(i=h.window)||void 0===i||i.focus())})),a.api.onWillFocus((()=>{var e;null===(e=h.window)||void 0===e||e.focus()})));const f=s&&n&&this.getPanel(n.id),G={window:h,popoutGroup:a,referenceGroup:f?n.id:void 0,disposable:{dispose:()=>(u.dispose(),m)}},w=onDidWindowMoveEnd(h.window);return u.addDisposables(w,onDidWindowResizeEnd(h.window,(()=>{this._onDidPopoutGroupSizeChange.fire({width:h.window.innerWidth,height:h.window.innerHeight,group:a})})),w.event((()=>{this._onDidPopoutGroupPositionChange.fire({screenX:h.window.screenX,screenY:h.window.screenX,group:a})})),addDisposableListener(h.window,"resize",(()=>{a.layout(h.window.innerWidth,h.window.innerHeight)})),d,Disposable.from((()=>{if(!this.isDisposed)if(s&&this.getPanel(n.id))this.movingLock((()=>moveGroupWithoutDestroying({from:a,to:n}))),n.api.isVisible||n.api.setVisible(!0),this.getPanel(a.id)&&this.doRemoveGroup(a,{skipPopoutAssociated:!0});else if(this.getPanel(a.id)){a.model.renderContainer=this.overlayRenderContainer,a.model.dropTargetContainer=this.rootDropTargetContainer,m=a;if(!this._popoutGroups.find((e=>e.popoutGroup===a)))return;v?this.addFloatingGroup(a,{height:v.height,width:v.width,position:v}):(this.doRemoveGroup(a,{skipDispose:!0,skipActive:!0,skipPopoutReturn:!0}),a.model.location={type:"grid"},this.movingLock((()=>{this.doAddGroup(a,[0])}))),this.doSetGroupAndPanelActive(a)}}))),this._popoutGroups.push(G),this.updateWatermark(),!0})).catch((e=>(console.error("dockview: failed to create popout.",e),!1)))}addFloatingGroup(e,i){var o,t,n,r,s;let a;if(e instanceof DockviewPanel)a=this.createGroup(),this._onDidAddGroup.fire(a),this.movingLock((()=>this.removePanel(e,{removeEmptyGroup:!0,skipDispose:!0,skipSetActiveGroup:!0}))),this.movingLock((()=>a.model.openPanel(e,{skipSetGroupActive:!0})));else{a=e;const t=null===(o=this._popoutGroups.find((e=>e.popoutGroup===a)))||void 0===o?void 0:o.referenceGroup,n=t?this.getPanel(t):void 0;"boolean"==typeof(null==i?void 0:i.skipRemoveGroup)&&i.skipRemoveGroup||(n?(this.movingLock((()=>moveGroupWithoutDestroying({from:e,to:n}))),this.doRemoveGroup(e,{skipPopoutReturn:!0,skipPopoutAssociated:!0}),this.doRemoveGroup(n,{skipDispose:!0}),a=n):this.doRemoveGroup(e,{skipDispose:!0,skipPopoutReturn:!0,skipPopoutAssociated:!1}))}const p=function(){if(null==i?void 0:i.position){const e={};return"left"in i.position?e.left=Math.max(i.position.left,0):"right"in i.position?e.right=Math.max(i.position.right,0):e.left=DEFAULT_FLOATING_GROUP_POSITION.left,"top"in i.position?e.top=Math.max(i.position.top,0):"bottom"in i.position?e.bottom=Math.max(i.position.bottom,0):e.top=DEFAULT_FLOATING_GROUP_POSITION.top,"number"==typeof i.width?e.width=Math.max(i.width,0):e.width=DEFAULT_FLOATING_GROUP_POSITION.width,"number"==typeof i.height?e.height=Math.max(i.height,0):e.height=DEFAULT_FLOATING_GROUP_POSITION.height,e}return{left:"number"==typeof(null==i?void 0:i.x)?Math.max(i.x,0):DEFAULT_FLOATING_GROUP_POSITION.left,top:"number"==typeof(null==i?void 0:i.y)?Math.max(i.y,0):DEFAULT_FLOATING_GROUP_POSITION.top,width:"number"==typeof(null==i?void 0:i.width)?Math.max(i.width,0):DEFAULT_FLOATING_GROUP_POSITION.width,height:"number"==typeof(null==i?void 0:i.height)?Math.max(i.height,0):DEFAULT_FLOATING_GROUP_POSITION.height}}(),d=new Overlay(Object.assign(Object.assign({container:this.gridview.element,content:a.element},p),{minimumInViewportWidth:"boundedWithinViewport"===this.options.floatingGroupBounds?void 0:null!==(n=null===(t=this.options.floatingGroupBounds)||void 0===t?void 0:t.minimumWidthWithinViewport)&&void 0!==n?n:DEFAULT_FLOATING_GROUP_OVERFLOW_SIZE,minimumInViewportHeight:"boundedWithinViewport"===this.options.floatingGroupBounds?void 0:null!==(s=null===(r=this.options.floatingGroupBounds)||void 0===r?void 0:r.minimumHeightWithinViewport)&&void 0!==s?s:DEFAULT_FLOATING_GROUP_OVERFLOW_SIZE})),l=a.element.querySelector(".dv-void-container");if(!l)throw new Error("failed to find drag handle");d.setupDrag(l,{inDragMode:"boolean"==typeof(null==i?void 0:i.inDragMode)&&i.inDragMode});const h=new DockviewFloatingGroupPanel(a,d),u=new CompositeDisposable(a.api.onDidActiveChange((e=>{e.isActive&&d.bringToFront()})),watchElementResize(a.element,(e=>{const{width:i,height:o}=e.contentRect;a.layout(i,o)})));h.addDisposables(d.onDidChange((()=>{a.layout(a.width,a.height)})),d.onDidChangeEnd((()=>{this._bufferOnDidLayoutChange.fire()})),a.onDidChange((e=>{d.setBounds({height:null==e?void 0:e.height,width:null==e?void 0:e.width})})),{dispose:()=>{u.dispose(),remove(this._floatingGroups,h),a.model.location={type:"grid"},this.updateWatermark()}}),this._floatingGroups.push(h),a.model.location={type:"floating"},(null==i?void 0:i.skipActiveGroup)||this.doSetGroupAndPanelActive(a),this.updateWatermark()}orthogonalize(e,i){switch(this.gridview.normalize(),e){case"top":case"bottom":this.gridview.orientation===Orientation.HORIZONTAL&&this.gridview.insertOrthogonalSplitviewAtRoot();break;case"left":case"right":this.gridview.orientation===Orientation.VERTICAL&&this.gridview.insertOrthogonalSplitviewAtRoot()}switch(e){case"top":case"left":case"center":return this.createGroupAtLocation([0],void 0,i);case"bottom":case"right":return this.createGroupAtLocation([this.gridview.length],void 0,i);default:throw new Error(`unsupported position ${e}`)}}updateOptions(e){var i,o;if(super.updateOptions(e),"floatingGroupBounds"in e)for(const t of this._floatingGroups){switch(e.floatingGroupBounds){case"boundedWithinViewport":t.overlay.minimumInViewportHeight=void 0,t.overlay.minimumInViewportWidth=void 0;break;case void 0:t.overlay.minimumInViewportHeight=DEFAULT_FLOATING_GROUP_OVERFLOW_SIZE,t.overlay.minimumInViewportWidth=DEFAULT_FLOATING_GROUP_OVERFLOW_SIZE;break;default:t.overlay.minimumInViewportHeight=null===(i=e.floatingGroupBounds)||void 0===i?void 0:i.minimumHeightWithinViewport,t.overlay.minimumInViewportWidth=null===(o=e.floatingGroupBounds)||void 0===o?void 0:o.minimumWidthWithinViewport}t.overlay.setBounds()}this.updateDropTargetModel(e);const t=this.options.disableDnd;this._options=Object.assign(Object.assign({},this.options),e);t!==this.options.disableDnd&&this.updateDragAndDropState(),"theme"in e&&this.updateTheme(),this.layout(this.gridview.width,this.gridview.height,!0)}layout(e,i,o){if(super.layout(e,i,o),this._floatingGroups)for(const e of this._floatingGroups)e.overlay.setBounds()}updateDragAndDropState(){for(const e of this.groups)e.model.updateDragAndDropState()}focus(){var e;null===(e=this.activeGroup)||void 0===e||e.focus()}getGroupPanel(e){return this.panels.find((i=>i.id===e))}setActivePanel(e){e.group.model.openPanel(e),this.doSetGroupAndPanelActive(e.group)}moveToNext(e={}){var i;if(!e.group){if(!this.activeGroup)return;e.group=this.activeGroup}if(e.includePanel&&e.group&&e.group.activePanel!==e.group.panels[e.group.panels.length-1])return void e.group.model.moveToNext({suppressRoll:!0});const o=getGridLocation(e.group.element),t=null===(i=this.gridview.next(o))||void 0===i?void 0:i.view;this.doSetGroupAndPanelActive(t)}moveToPrevious(e={}){var i;if(!e.group){if(!this.activeGroup)return;e.group=this.activeGroup}if(e.includePanel&&e.group&&e.group.activePanel!==e.group.panels[0])return void e.group.model.moveToPrevious({suppressRoll:!0});const o=getGridLocation(e.group.element),t=null===(i=this.gridview.previous(o))||void 0===i?void 0:i.view;t&&this.doSetGroupAndPanelActive(t)}toJSON(){var e;const i=this.gridview.serialize(),o=this.panels.reduce(((e,i)=>(e[i.id]=i.toJSON(),e)),{}),t=this._floatingGroups.map((e=>({data:e.group.toJSON(),position:e.overlay.toJSON()}))),n=this._popoutGroups.map((e=>({data:e.popoutGroup.toJSON(),gridReferenceGroup:e.referenceGroup,position:e.window.dimensions(),url:"popout"===e.popoutGroup.api.location.type?e.popoutGroup.api.location.popoutUrl:void 0}))),r={grid:i,panels:o,activeGroup:null===(e=this.activeGroup)||void 0===e?void 0:e.id};return t.length>0&&(r.floatingGroups=t),n.length>0&&(r.popoutGroups=n),r}fromJSON(e){var i,o;if(this.clear(),"object"!=typeof e||null===e)throw new Error("serialized layout must be a non-null object");const{grid:t,panels:n,activeGroup:r}=e;if("branch"!==t.root.type||!Array.isArray(t.root.data))throw new Error("root must be of type branch");try{const s=this.width,a=this.height,p=e=>{const{id:i,locked:o,hideHeader:t,views:r,activeView:s}=e;if("string"!=typeof i)throw new Error("group id must be of type string");const a=this.createGroup({id:i,locked:!!o,hideHeader:!!t});this._onDidAddGroup.fire(a);const p=[];for(const e of r){const i=this._deserializer.fromJSON(n[e],a);p.push(i)}for(let e=0;e<r.length;e++){const i=p[e],o="string"==typeof s&&s===i.id;a.model.openPanel(i,{skipSetActive:!o,skipSetGroupActive:!0})}return!a.activePanel&&a.panels.length>0&&a.model.openPanel(a.panels[a.panels.length-1],{skipSetGroupActive:!0}),a};this.gridview.deserialize(t,{fromJSON:e=>p(e.data)}),this.layout(s,a,!0);const d=null!==(i=e.floatingGroups)&&void 0!==i?i:[];for(const e of d){const{data:i,position:o}=e,t=p(i);this.addFloatingGroup(t,{position:o,width:o.width,height:o.height,skipRemoveGroup:!0,inDragMode:!1})}const l=null!==(o=e.popoutGroups)&&void 0!==o?o:[],h=[];l.forEach(((e,i)=>{const{data:o,position:t,gridReferenceGroup:n,url:r}=e,s=p(o),a=new Promise((e=>{setTimeout((()=>{this.addPopoutGroup(s,{position:null!=t?t:void 0,overridePopoutGroup:n?s:void 0,referenceGroup:n?this.getPanel(n):void 0,popoutUrl:r}),e()}),i*DESERIALIZATION_POPOUT_DELAY_MS)}));h.push(a)})),this._popoutRestorationPromise=Promise.all(h).then((()=>{}));for(const e of this._floatingGroups)e.overlay.setBounds();if("string"==typeof r){const e=this.getPanel(r);e&&this.doSetGroupAndPanelActive(e)}}catch(e){console.error("dockview: failed to deserialize layout. Reverting changes",e);for(const e of this.groups)for(const i of e.panels)this.removePanel(i,{removeEmptyGroup:!1,skipDispose:!1});for(const e of this.groups)e.dispose(),this._groups.delete(e.id),this._onDidRemoveGroup.fire(e);for(const e of[...this._floatingGroups])e.dispose();throw this.clear(),e}this.updateWatermark(),requestAnimationFrame((()=>{this.overlayRenderContainer.updateAllPositions()})),this._onDidLayoutFromJSON.fire()}clear(){const e=Array.from(this._groups.values()).map((e=>e.value)),i=!!this.activeGroup;for(const i of e)this.removeGroup(i,{skipActive:!0});i&&this.doSetGroupAndPanelActive(void 0),this.gridview.clear()}closeAllGroups(){for(const e of this._groups.entries()){const[i,o]=e;o.value.model.closeAllPanels()}}addPanel(e){var i,o;if(this.panels.find((i=>i.id===e.id)))throw new Error(`panel with id ${e.id} already exists`);let t;if(e.position&&e.floating)throw new Error("you can only provide one of: position, floating as arguments to .addPanel(...)");const n={width:e.initialWidth,height:e.initialHeight};let r,s;if(e.position)if(isPanelOptionsWithPanel(e.position)){const i="string"==typeof e.position.referencePanel?this.getGroupPanel(e.position.referencePanel):e.position.referencePanel;if(r=e.position.index,!i)throw new Error(`referencePanel '${e.position.referencePanel}' does not exist`);t=this.findGroup(i)}else{if(!isPanelOptionsWithGroup(e.position)){const i=this.orthogonalize(directionToPosition(e.position.direction)),o=this.createPanel(e,i);return i.model.openPanel(o,{skipSetActive:e.inactive,skipSetGroupActive:e.inactive,index:r}),e.inactive||this.doSetGroupAndPanelActive(i),i.api.setSize({height:null==n?void 0:n.height,width:null==n?void 0:n.width}),o}if(t="string"==typeof e.position.referenceGroup?null===(i=this._groups.get(e.position.referenceGroup))||void 0===i?void 0:i.value:e.position.referenceGroup,r=e.position.index,!t)throw new Error(`referenceGroup '${e.position.referenceGroup}' does not exist`)}else t=this.activeGroup;if(t){const i=toTarget((null===(o=e.position)||void 0===o?void 0:o.direction)||"within");if(e.floating){const i=this.createGroup();this._onDidAddGroup.fire(i);const o="object"==typeof e.floating&&null!==e.floating?e.floating:{};this.addFloatingGroup(i,Object.assign(Object.assign({},o),{inDragMode:!1,skipRemoveGroup:!0,skipActiveGroup:!0})),s=this.createPanel(e,i),i.model.openPanel(s,{skipSetActive:e.inactive,skipSetGroupActive:e.inactive,index:r})}else if("floating"===t.api.location.type||"center"===i)s=this.createPanel(e,t),t.model.openPanel(s,{skipSetActive:e.inactive,skipSetGroupActive:e.inactive,index:r}),t.api.setSize({width:null==n?void 0:n.width,height:null==n?void 0:n.height}),e.inactive||this.doSetGroupAndPanelActive(t);else{const o=getGridLocation(t.element),a=getRelativeLocation(this.gridview.orientation,o,i),p=this.createGroupAtLocation(a,this.orientationAtLocation(a)===Orientation.VERTICAL?null==n?void 0:n.height:null==n?void 0:n.width);s=this.createPanel(e,p),p.model.openPanel(s,{skipSetActive:e.inactive,skipSetGroupActive:e.inactive,index:r}),e.inactive||this.doSetGroupAndPanelActive(p)}}else if(e.floating){const i=this.createGroup();this._onDidAddGroup.fire(i);const o="object"==typeof e.floating&&null!==e.floating?e.floating:{};this.addFloatingGroup(i,Object.assign(Object.assign({},o),{inDragMode:!1,skipRemoveGroup:!0,skipActiveGroup:!0})),s=this.createPanel(e,i),i.model.openPanel(s,{skipSetActive:e.inactive,skipSetGroupActive:e.inactive,index:r})}else{const i=this.createGroupAtLocation([0],this.gridview.orientation===Orientation.VERTICAL?null==n?void 0:n.height:null==n?void 0:n.width);s=this.createPanel(e,i),i.model.openPanel(s,{skipSetActive:e.inactive,skipSetGroupActive:e.inactive,index:r}),e.inactive||this.doSetGroupAndPanelActive(i)}return s}removePanel(e,i={removeEmptyGroup:!0}){const o=e.group;if(!o)throw new Error(`cannot remove panel ${e.id}. it's missing a group.`);o.model.removePanel(e,{skipSetActiveGroup:i.skipSetActiveGroup}),i.skipDispose||(e.group.model.renderContainer.detatch(e),e.dispose()),0===o.size&&i.removeEmptyGroup&&this.removeGroup(o,{skipActive:i.skipSetActiveGroup})}createWatermarkComponent(){return this.options.createWatermarkComponent?this.options.createWatermarkComponent():new Watermark}updateWatermark(){var e,i;if(0===this.groups.filter((e=>"grid"===e.api.location.type&&e.api.isVisible)).length){if(!this._watermark){this._watermark=this.createWatermarkComponent(),this._watermark.init({containerApi:new DockviewApi(this)});const e=document.createElement("div");e.className="dv-watermark-container",addTestId(e,"watermark-component"),e.appendChild(this._watermark.element),this.gridview.element.appendChild(e)}}else this._watermark&&(this._watermark.element.parentElement.remove(),null===(i=(e=this._watermark).dispose)||void 0===i||i.call(e),this._watermark=null)}addGroup(e){var i;if(e){let o;if(isGroupOptionsWithPanel(e)){const i="string"==typeof e.referencePanel?this.panels.find((i=>i.id===e.referencePanel)):e.referencePanel;if(!i)throw new Error(`reference panel ${e.referencePanel} does not exist`);if(o=this.findGroup(i),!o)throw new Error(`reference group for reference panel ${e.referencePanel} does not exist`)}else{if(!isGroupOptionsWithGroup(e)){const i=this.orthogonalize(directionToPosition(e.direction),e);return e.skipSetActive||this.doSetGroupAndPanelActive(i),i}if(o="string"==typeof e.referenceGroup?null===(i=this._groups.get(e.referenceGroup))||void 0===i?void 0:i.value:e.referenceGroup,!o)throw new Error(`reference group ${e.referenceGroup} does not exist`)}const t=toTarget(e.direction||"within"),n=getGridLocation(o.element),r=getRelativeLocation(this.gridview.orientation,n,t),s=this.createGroup(e),a=this.getLocationOrientation(r)===Orientation.VERTICAL?e.initialHeight:e.initialWidth;return this.doAddGroup(s,r,a),e.skipSetActive||this.doSetGroupAndPanelActive(s),s}{const i=this.createGroup(e);return this.doAddGroup(i),this.doSetGroupAndPanelActive(i),i}}getLocationOrientation(e){return e.length%2==0&&this.gridview.orientation===Orientation.HORIZONTAL?Orientation.HORIZONTAL:Orientation.VERTICAL}removeGroup(e,i){this.doRemoveGroup(e,i)}doRemoveGroup(e,i){var o;const t=[...e.panels];if(!(null==i?void 0:i.skipDispose))for(const e of t)this.removePanel(e,{removeEmptyGroup:!1,skipDispose:null!==(o=null==i?void 0:i.skipDispose)&&void 0!==o&&o});const n=this.activePanel;if("floating"===e.api.location.type){const o=this._floatingGroups.find((i=>i.group===e));if(o){if((null==i?void 0:i.skipDispose)||(o.group.dispose(),this._groups.delete(e.id),this._onDidRemoveGroup.fire(e)),remove(this._floatingGroups,o),o.dispose(),!(null==i?void 0:i.skipActive)&&this._activeGroup===e){const e=Array.from(this._groups.values());this.doSetGroupAndPanelActive(e.length>0?e[0].value:void 0)}return o.group}throw new Error("failed to find floating group")}if("popout"===e.api.location.type){const o=this._popoutGroups.find((i=>i.popoutGroup===e));if(o){if(!(null==i?void 0:i.skipDispose)){if(!(null==i?void 0:i.skipPopoutAssociated)){const e=o.referenceGroup?this.getPanel(o.referenceGroup):void 0;e&&0===e.panels.length&&this.removeGroup(e)}o.popoutGroup.dispose(),this._groups.delete(e.id),this._onDidRemoveGroup.fire(e)}remove(this._popoutGroups,o);const t=o.disposable.dispose();if(!(null==i?void 0:i.skipPopoutReturn)&&t&&(this.doAddGroup(t,[0]),this.doSetGroupAndPanelActive(t)),!(null==i?void 0:i.skipActive)&&this._activeGroup===e){const e=Array.from(this._groups.values());this.doSetGroupAndPanelActive(e.length>0?e[0].value:void 0)}return this.updateWatermark(),o.popoutGroup}throw new Error("failed to find popout group")}const r=super.doRemoveGroup(e,i);return(null==i?void 0:i.skipActive)||this.activePanel!==n&&this._onDidActivePanelChange.fire(this.activePanel),r}movingLock(e){const i=this._moving;try{return this._moving=!0,e()}finally{this._moving=i}}moveGroupOrPanel(e){var i;const o=e.to.group,t=e.from.groupId,n=e.from.panelId,r=e.to.position,s=e.to.index,a=t?null===(i=this._groups.get(t))||void 0===i?void 0:i.value:void 0;if(!a)throw new Error(`Failed to find group id ${t}`);if(void 0!==n)if(r&&"center"!==r){const e=getGridLocation(o.element),i=getRelativeLocation(this.gridview.orientation,e,r);if(a.size<2){const[e,t]=tail(i);if("grid"===a.api.location.type){const i=getGridLocation(a.element),[o,r]=tail(i);if(sequenceEquals(o,e))return this.gridview.moveView(o,r,t),void this._onDidMovePanel.fire({panel:this.getGroupPanel(n),from:a})}if("popout"===a.api.location.type){const e=this._popoutGroups.find((e=>e.popoutGroup===a)),o=this.movingLock((()=>e.popoutGroup.model.removePanel(e.popoutGroup.panels[0],{skipSetActive:!0,skipSetActiveGroup:!0})));this.doRemoveGroup(a,{skipActive:!0});const t=this.createGroupAtLocation(i);return this.movingLock((()=>t.model.openPanel(o))),this.doSetGroupAndPanelActive(t),void this._onDidMovePanel.fire({panel:this.getGroupPanel(n),from:a})}const s=this.movingLock((()=>this.doRemoveGroup(a,{skipActive:!0,skipDispose:!0}))),p=getGridLocation(o.element),d=getRelativeLocation(this.gridview.orientation,p,r);this.movingLock((()=>this.doAddGroup(s,d))),this.doSetGroupAndPanelActive(s),this._onDidMovePanel.fire({panel:this.getGroupPanel(n),from:a})}else{const i=this.movingLock((()=>a.model.removePanel(n,{skipSetActive:!1,skipSetActiveGroup:!0})));if(!i)throw new Error(`No panel with id ${n}`);const o=getRelativeLocation(this.gridview.orientation,e,r),t=this.createGroupAtLocation(o);this.movingLock((()=>t.model.openPanel(i,{skipSetGroupActive:!0}))),this.doSetGroupAndPanelActive(t),this._onDidMovePanel.fire({panel:i,from:a})}}else{const i=this.movingLock((()=>a.model.removePanel(n,{skipSetActive:!1,skipSetActiveGroup:!0})));if(!i)throw new Error(`No panel with id ${n}`);0===a.model.size&&this.doRemoveGroup(a,{skipActive:!0});const t=0===o.model.size;this.movingLock((()=>{var n;return o.model.openPanel(i,{index:s,skipSetActive:null!==(n=e.skipSetActive)&&void 0!==n&&n&&!t,skipSetGroupActive:!0})})),e.skipSetActive||this.doSetGroupAndPanelActive(o),this._onDidMovePanel.fire({panel:i,from:a})}else this.moveGroup({from:{group:a},to:{group:o,position:r},skipSetActive:e.skipSetActive})}moveGroup(e){const i=e.from.group,o=e.to.group,t=e.to.position;if("center"===t){const t=i.activePanel,n=this.movingLock((()=>[...i.panels].map((e=>i.model.removePanel(e.id,{skipSetActive:!0})))));0===(null==i?void 0:i.model.size)&&this.doRemoveGroup(i,{skipActive:!0}),this.movingLock((()=>{for(const e of n)o.model.openPanel(e,{skipSetActive:e!==t,skipSetGroupActive:!0})})),!0!==e.skipSetActive?this.doSetGroupAndPanelActive(o):this.activePanel||this.doSetGroupAndPanelActive(o)}else{switch(i.api.location.type){case"grid":this.gridview.removeView(getGridLocation(i.element));break;case"floating":{const e=this._floatingGroups.find((e=>e.group===i));if(!e)throw new Error("failed to find floating group");e.dispose();break}case"popout":{const e=this._popoutGroups.find((e=>e.popoutGroup===i));if(!e)throw new Error("failed to find popout group");const t=this._popoutGroups.indexOf(e);if(t>=0&&this._popoutGroups.splice(t,1),e.referenceGroup){const i=this.getPanel(e.referenceGroup);i&&!i.api.isVisible&&this.doRemoveGroup(i,{skipActive:!0})}e.window.dispose(),"grid"===o.api.location.type?(i.model.renderContainer=this.overlayRenderContainer,i.model.dropTargetContainer=this.rootDropTargetContainer,i.model.location={type:"grid"}):"floating"===o.api.location.type&&(i.model.renderContainer=this.overlayRenderContainer,i.model.dropTargetContainer=this.rootDropTargetContainer,i.model.location={type:"floating"});break}}if("grid"===o.api.location.type){const e=getGridLocation(o.element),n=getRelativeLocation(this.gridview.orientation,e,t);let r;switch(this.gridview.orientation){case Orientation.VERTICAL:r=e.length%2==0?i.api.width:i.api.height;break;case Orientation.HORIZONTAL:r=e.length%2==0?i.api.height:i.api.width}this.gridview.addView(i,r,n)}else if("floating"===o.api.location.type){const e=this._floatingGroups.find((e=>e.group===o));if(e){const o=e.overlay.toJSON();let t,n;t="left"in o?o.left+50:"right"in o?Math.max(0,o.right-o.width-50):50,n="top"in o?o.top+50:"bottom"in o?Math.max(0,o.bottom-o.height-50):50,this.addFloatingGroup(i,{height:o.height,width:o.width,position:{left:t,top:n}})}}}if(i.panels.forEach((e=>{this._onDidMovePanel.fire({panel:e,from:i})})),!1===e.skipSetActive){const e=null!=o?o:i;this.doSetGroupAndPanelActive(e)}}doSetGroupActive(e){super.doSetGroupActive(e);const i=this.activePanel;this._moving||i===this._onDidActivePanelChange.value||this._onDidActivePanelChange.fire(i)}doSetGroupAndPanelActive(e){super.doSetGroupActive(e);const i=this.activePanel;e&&this.hasMaximizedGroup()&&!this.isMaximizedGroup(e)&&this.exitMaximizedGroup(),this._moving||i===this._onDidActivePanelChange.value||this._onDidActivePanelChange.fire(i)}getNextGroupId(){let e=this.nextGroupId.next();for(;this._groups.has(e);)e=this.nextGroupId.next();return e}createGroup(e){e||(e={});let i=null==e?void 0:e.id;if(i&&this._groups.has(e.id)&&(console.warn(`dockview: Duplicate group id ${null==e?void 0:e.id}. reassigning group id to avoid errors`),i=void 0),!i)for(i=this.nextGroupId.next();this._groups.has(i);)i=this.nextGroupId.next();const o=new DockviewGroupPanel(this,i,e);if(o.init({params:{},accessor:this}),!this._groups.has(o.id)){const e=new CompositeDisposable(o.model.onTabDragStart((e=>{this._onWillDragPanel.fire(e)})),o.model.onGroupDragStart((e=>{this._onWillDragGroup.fire(e)})),o.model.onMove((e=>{const{groupId:i,itemId:t,target:n,index:r}=e;this.moveGroupOrPanel({from:{groupId:i,panelId:t},to:{group:o,position:n,index:r}})})),o.model.onDidDrop((e=>{this._onDidDrop.fire(e)})),o.model.onWillDrop((e=>{this._onWillDrop.fire(e)})),o.model.onWillShowOverlay((e=>{this.options.disableDnd?e.preventDefault():this._onWillShowOverlay.fire(e)})),o.model.onUnhandledDragOverEvent((e=>{this._onUnhandledDragOverEvent.fire(e)})),o.model.onDidAddPanel((e=>{this._moving||this._onDidAddPanel.fire(e.panel)})),o.model.onDidRemovePanel((e=>{this._moving||this._onDidRemovePanel.fire(e.panel)})),o.model.onDidActivePanelChange((e=>{this._moving||e.panel===this.activePanel&&this._onDidActivePanelChange.value!==e.panel&&this._onDidActivePanelChange.fire(e.panel)})),Event.any(o.model.onDidPanelTitleChange,o.model.onDidPanelParametersChange)((()=>{this._bufferOnDidLayoutChange.fire()})));this._groups.set(o.id,{value:o,disposable:e})}return o.initialize(),o}createPanel(e,i){var o,t,n;const r=e.component,s=null!==(o=e.tabComponent)&&void 0!==o?o:this.options.defaultTabComponent,a=new DockviewPanelModel(this,e.id,r,s),p=new DockviewPanel(e.id,r,s,this,this._api,i,a,{renderer:e.renderer,minimumWidth:e.minimumWidth,minimumHeight:e.minimumHeight,maximumWidth:e.maximumWidth,maximumHeight:e.maximumHeight});return p.init({title:null!==(t=e.title)&&void 0!==t?t:e.id,params:null!==(n=null==e?void 0:e.params)&&void 0!==n?n:{}}),p}createGroupAtLocation(e,i,o){const t=this.createGroup(o);return this.doAddGroup(t,e,i),t}findGroup(e){var i;return null===(i=Array.from(this._groups.values()).find((i=>i.value.model.containsPanel(e))))||void 0===i?void 0:i.value}orientationAtLocation(e){const i=this.gridview.orientation;return e.length%2==1?i:orthogonal(i)}updateDropTargetModel(e){"dndEdges"in e&&(this._rootDropTarget.disabled="boolean"==typeof e.dndEdges&&!1===e.dndEdges,"object"==typeof e.dndEdges&&null!==e.dndEdges?this._rootDropTarget.setOverlayModel(e.dndEdges):this._rootDropTarget.setOverlayModel(DEFAULT_ROOT_OVERLAY_MODEL)),"rootOverlayModel"in e&&this.updateDropTargetModel({dndEdges:e.dndEdges})}updateTheme(){var e,i;const o=null!==(e=this._options.theme)&&void 0!==e?e:themeAbyss;if(this._themeClassnames.setClassNames(o.className),this.gridview.margin=null!==(i=o.gap)&&void 0!==i?i:0,"absolute"===o.dndOverlayMounting)this.rootDropTargetContainer.disabled=!1;else this.rootDropTargetContainer.disabled=!0}}
//# sourceMappingURL=/sm/429d52cc43779ae181b7ef228aca46d1c49759438df93d25b2bdd4e3335922d3.map