export function initializeMudExDockLayout(t,i,r,u){if(i.__mudExDockInstance&&i.__mudExDockInstance instanceof n){const n=i.__mudExDockInstance;return n.setOptions?.(u||n.options),n.dotnet=r||n.dotnet,n}const f=new n(t,i,r,u);return i.__mudExDockInstance=f,f}class n{elementRef;dotnet;options;containerRef;api;elementStore=new Map;bootstrapped=false;observer=null;disposables=[];_isReinitializing=false;instanceId=crypto?.randomUUID?crypto.randomUUID():String(Date.now())+Math.random();constructor(n,t,i,r){this.elementRef=n;this.dotnet=i;this.containerRef=t;this.options=r||{};this.init()}async init(){const{createDockview:n}=await import(this.options.module);if(this.api=n(this.containerRef,{theme:{className:this.options.className??"dockview-theme-abyss"},dndEdges:{top:!0,right:!0,bottom:!0,left:!0},createComponent:n=>this._createComponent(n)}),this.indexDomLeaves(),this.options.initialLayoutJson)try{this.api.fromJSON(JSON.parse(this.options.initialLayoutJson));this.bootstrapped=!0;this.dotnet?.invokeMethodAsync("OnJsReady");return}catch(t){console.warn("fromJSON failed",t)}this.dotnet?.invokeMethodAsync("OnJsReady");this.observeAndBootstrap();this.wireEvents()}_ensureStash(){let n=this.containerRef.querySelector(":scope > .dv-stash");return n||(n=document.createElement("div"),n.className="dv-stash",n.style.display="none",this.containerRef.appendChild(n)),n}_hideAndStash(n,t){if(n)try{n.dataset.dvId=t;n.style.display="none";this._ensureStash().appendChild(n)}catch{}}_hideAndStashDuplicates(n,t=null){const i=`[data-dv-id="${CSS.escape(n)}"], .dv-node[data-options*='"id":"${CSS.escape(n)}"']`,r=this.containerRef.querySelectorAll(i);for(const i of r)t&&i===t||this._hideAndStash(i,n)}_createComponent(n){let t=this.elementStore.get(n.id);if(!t){const i=this.containerRef.querySelector(`:scope > .dv-stash [data-dv-id="${CSS.escape(n.id)}"]`);i&&(t=i,this.elementStore.set(n.id,t))}if(!t){const i=this.containerRef.querySelector(`.dv-node [data-dv-id="${CSS.escape(n.id)}"], .dv-node[data-options*='"id":"${CSS.escape(n.id)}"']`);i&&(t=i,this.elementStore.set(n.id,t))}if(t)return t.dataset.dvId=n.id,t.style.display="",t.style.height="100%",t.style.width="100%",t.style.overflow="auto",this._hideAndStashDuplicates(n.id,t),{element:t,init(){},update(){},dispose:()=>this._hideAndStash(t,n.id)};const i=document.createElement("div");return i.textContent="blazor",{element:i,init(){},update(){},dispose(){}}}wireEvents(){this.disposeEvents();const n=n=>this.disposables.push(n).length&&n;try{n(this.api.onDidAddPanel?.(n=>this.dotnet?.invokeMethodAsync("OnJsPanelAdded",n.id)))}catch(t){}try{n(this.api.onDidRemovePanel?.(n=>this.dotnet?.invokeMethodAsync("OnJsPanelRemoved",n.id)))}catch(t){}try{n(this.api.onDidActivePanelChange?.(n=>this.dotnet?.invokeMethodAsync("OnJsActiveChanged",n?.id??null)))}catch(t){}try{n(this.api.onDidMovePanel?.(n=>{const t={PanelId:n.panel?.id??null,FromGroupId:n.from?.id??n.fromGroup?.id??null,ToGroupId:n.to?.id??n.toGroup?.id??null,ToIndex:n.index??0};this.dotnet?.invokeMethodAsync("OnJsPanelMoved",t)}))}catch(t){}}disposeEvents(){for(const n of this.disposables||[])try{n?.dispose?.()}catch(t){}this.disposables=[]}indexDomLeaves(){const n=this.containerRef.querySelectorAll(".dv-node");for(const t of n){const i=Array.from(t.children).some(n=>n.classList?.contains("dv-node"));if(!i){const r=JSON.parse(t.dataset.options||"{}"),n=r.id;if(n){if(this.elementStore.has(n)){this._hideAndStash(t,n);continue}t.dataset.dvId=n;t.style.display="none";this.elementStore.set(n,t);this._hideAndStashDuplicates(n,t)}}}}observeAndBootstrap(){const n=()=>{if(!this.bootstrapped){const n=this._rootNodes();n.length!==0&&(this.bootstrapFromDom(n),this.bootstrapped=!0,this.observer?.disconnect())}};n();this.observer=new MutationObserver(()=>n());this.observer.observe(this.containerRef,{childList:!0,subtree:!0})}setOptions(n){this.options=n}_rootNodes(){return Array.from(this.containerRef.children).filter(n=>n.classList?.contains("dv-node"))}bootstrapFromDom(n){const t=[];for(const i of n){const r=JSON.parse(i.dataset.options||"{}"),u=r.direction?.toLowerCase()||"right";let n=null;this._planFromNode(i,u,t,()=>n,t=>{n=t})}for(const n of t){const t=this.api.addPanel(n);t.isVisible=n.isVisible;n.hideHeader!==!0||this.containerRef.classList.contains("dv-hide-tabs")||(t.group.header.hidden=!0);n.float===!0&&this.api.addFloatingGroup(t,n.floatBounds||undefined);n.locked!=null&&(t.group.locked=n.locked)}}_planFromNode(n,t,i,r,u){const e=Array.from(n.children).filter(n=>n.classList?.contains("dv-node")),s=e.length>0,f=JSON.parse(n.dataset.options||"{}");if(!s){const n=r();i.push(f);f.position=n?{referencePanel:n,direction:t}:{direction:t};u(f.id);return}const h=f.direction?.toLowerCase()||t||"right";let o=null;for(const n of e)this._planFromNode(n,h,i,()=>o,n=>{o=n})}toJSON(){try{return JSON.stringify(this.api?.toJSON()??{})}catch(n){return"{}"}}fromJSON(n){try{this.api?.fromJSON(typeof n=="string"?JSON.parse(n):n)}catch(t){}}async reinitialize(n={}){if(!this._isReinitializing){this._isReinitializing=!0;const{preserveLayout:r=!0,raiseReady:u=!1,initialLayoutJson:i=null}=n;let t="{}";if(r)try{t=this.toJSON()}catch(f){t="{}"}else i&&(t=i);try{const n=this._ensureStash();for(const[i,t]of this.elementStore.entries())if(t)try{t.dataset.dvId=i;t.parentElement!==n&&n.appendChild(t);t.style.display="none"}catch{}}catch{}try{this.disposeEvents()}catch{}try{this.observer?.disconnect?.()}catch{}try{this.api?.dispose?.()}catch{}const{createDockview:e}=await import(this.options.module);this.api=e(this.containerRef,{theme:{className:this.options.className??"dockview-theme-abyss"},dndEdges:{top:!0,right:!0,bottom:!0,left:!0},createComponent:n=>this._createComponent(n)});this.indexDomLeaves();try{const n=JSON.parse(t||"{}");if(n&&Object.keys(n).length>0)this.api.fromJSON(n),this.bootstrapped=!0;else{const n=this._rootNodes();n.length>0&&(this.bootstrapFromDom(n),this.bootstrapped=!0)}}catch(f){console.warn("reinitialize.fromJSON failed -> fallback to DOM bootstrap",f);const n=this._rootNodes();n.length>0&&(this.bootstrapFromDom(n),this.bootstrapped=!0)}if(this.wireEvents(),u)try{this.dotnet?.invokeMethodAsync("OnJsReady")}catch{}try{for(const[n,t]of this.elementStore.entries())n&&t&&this._hideAndStashDuplicates(n,t)}catch{}this._isReinitializing=!1}}dispose(){this.disposeEvents();try{this.observer?.disconnect?.()}catch{}try{this.api?.dispose?.()}catch{}}}window.MudExDockLayout=n;