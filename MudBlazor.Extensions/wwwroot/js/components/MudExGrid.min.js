function u(n,t){const i=[...n.classList].find(n=>n.startsWith(t));return i?parseInt(i.split("-").pop()):null}function v(n){const t=t=>{const i=[...n.classList].find(n=>n.startsWith(`mud-ex-grid-section-${t}-`));return i?parseInt(i.split("-").pop()):1},i=t("row-start"),u=t("row-end"),r=t("col-start"),f=t("col-end");return{row:i,col:r,rowSpan:u-i,colSpan:f-r}}function f(n){return[...n.querySelectorAll(".mud-ex-grid-section")].map(n=>({id:n.dataset.id,el:n,...v(n)}))}function e(n){const t=n.getBoundingClientRect(),i=u(n,"mud-ex-grid-row-")||12,r=u(n,"mud-ex-grid-column-")||12;return{rows:i,cols:r,cw:t.width/r,ch:t.height/i,left:t.left,top:t.top}}function n(n,t){return{x:(n.col-1)*t.cw,y:(n.row-1)*t.ch,w:n.colSpan*t.cw,h:n.rowSpan*t.ch}}function t(n,t){return!(n.row+n.rowSpan-1<t.row||t.row+t.rowSpan-1<n.row||n.col+n.colSpan-1<t.col||t.col+t.colSpan-1<n.col)}function o(n){n.querySelectorAll(".mud-ex-grid-section").forEach(n=>{n.style.transform="",n.style.transition=""})}function i(n,i){return!n.some(n=>n.id!==i.id&&t(i,n))}function s(n,i,r,u,f){const e=f.get(i.id)||{},o=Math.max(1,e.minCol??1),s=Math.min(u-i.colSpan+1,e.maxCol??Number.MAX_SAFE_INTEGER),h=Math.max(1,e.minRow??1),c=Math.min(r-i.rowSpan+1,e.maxRow??Number.MAX_SAFE_INTEGER);return i.col<o||i.col>s?!1:i.row<h||i.row>c?!1:i.row+i.rowSpan-1>r||i.col+i.colSpan-1>u?!1:!n.some(n=>n.id!==i.id&&t(i,n))}function y(n,i,r,u,f){if(s(n,i,r,u,f))return n;const e=[i],o=new Set([i.id]);while(e.length){const i=e.shift();for(const f of n)if(f.id!==i.id&&t(i,f)){const h=[{row:i.row+i.rowSpan,col:f.col},{row:f.row,col:i.col+i.colSpan}];let s=!1;for(const i of h){let o=Math.max(1,i.row),e=Math.max(1,i.col);while(o<=r&&!s){while(e<=u){const i={...f,row:o,col:e};if(!n.some(n=>n.id!==i.id&&t(i,n))&&i.row+i.rowSpan-1<=r&&i.col+i.colSpan-1<=u){f.row=i.row;f.col=i.col;s=!0;break}e++}s||(e=1,o++)}}o.has(f.id)||(e.push(f),o.add(f.id))}}return n}function h(n,i,r,u,f){if(s(n,i,r,u,f))return n;const e=n.filter(n=>n.id!==i.id&&t(i,n));if(e.length===1){const o=e[0],s=n.find(n=>n.id===i.id),f={...o,row:s.row,col:s.col},h=!n.some(n=>n.id!==o.id&&t(f,n))&&f.row+f.rowSpan-1<=r&&f.col+f.colSpan-1<=u;if(h)return o.row=s.row,o.col=s.col,n}return y(n,i,r,u,f)}function c(n,t){for(const r of n){let u=!0;while(u){const f={...r,row:Math.max(1,r.row-1)};if(f.row===r.row)break;if(f.row+f.rowSpan-1>t)break;const e=n.map(n=>n.id===r.id?f:n);i(e,f)?r.row=f.row:u=!1}}return n}function l(n){const t=[...n].sort((n,t)=>n.col-t.col||n.row-t.row);for(const r of t){let t=r.row;for(let u=1;u<r.row;u++){const f={...r,row:u},e=n.map(n=>n.id===r.id?f:n);if(i(e,f))t=u;else break}r.row=t}return n}function a(n,t,r,u){const o=r-t.rowSpan+1,s=u-t.colSpan+1;let f=null,e=Infinity;for(let r=1;r<=o;r++)for(let u=1;u<=s;u++){const o={...t,row:r,col:u},s=n.map(n=>n.id===t.id?o:n);if(i(s,o)){const n=Math.abs(r-t.row)+Math.abs(u-t.col);n<e&&(f=o,e=n)}}return f||t}const r=new WeakSet;export const mudexGrid={bind(n,t){if(n._mudex||(n._mudex={dotnet:t}),!n._mudex.observer){const t=new MutationObserver(()=>{[...n.querySelectorAll(".mud-ex-grid-section")].forEach(t=>{r.has(t)||(r.add(t),mudexGrid._wireOne(n,t))})});t.observe(n,{childList:!0,subtree:!0});n._mudex.observer=t}[...n.querySelectorAll(".mud-ex-grid-section")].forEach(t=>{r.has(t)||(r.add(t),mudexGrid._wireOne(n,t))})},_wireOne(n,t){mudexGrid.wireDrag(n,t);const i=t.querySelector(".mud-ex-grid-handle-e"),r=t.querySelector(".mud-ex-grid-handle-s"),u=t.querySelector(".mud-ex-grid-handle-se");mudexGrid.wireResize(n,t,[i,r,u])},wireDrag(t,r){const p=t.querySelector(".mud-ex-grid-overlay"),v=t.querySelector(".mud-ex-grid-placeholder");let s=null,u=null,y=null;const b=i=>{const y=JSON.parse(r.dataset.options);if(y.movable&&i.button===0){r.setPointerCapture(i.pointerId);s={x:i.clientX,y:i.clientY};const c=f(t),l=c.find(n=>n.el===r),w=c.filter(n=>n!==l),a=e(t);p.textContent="";const h=r.cloneNode(!0);h.classList.add("mud-ex-grid-clone");Object.assign(h.style,{position:"absolute",pointerEvents:"none",zIndex:30,left:0,top:0});p.appendChild(h);const o={...n(l,a)};Object.assign(h.style,{width:`${o.w}px`,height:`${o.h}px`,transform:`translate(${o.x}px,${o.y}px)`});v.style.display="block";Object.assign(v.style,{width:`${o.w}px`,height:`${o.h}px`,transform:`translate(${o.x}px,${o.y}px)`});u={base:c,me:l,others:w,m:a,clone:h,placeholder:v}}},k=f=>{if(s&&u){const e=JSON.parse(r.dataset.options),b=f.clientX-s.x,k=f.clientY-s.y,g=Math.trunc((b+Math.sign(b)*.4*u.m.cw)/u.m.cw),nt=Math.trunc((k+Math.sign(k)*.4*u.m.ch)/u.m.ch),tt=e.lockX?0:g,it=e.lockY?0:nt,l=u.m.rows,v=u.m.cols,rt=Math.max(1,e.minCol),ut=Math.min(v-u.me.colSpan+1,Number.isFinite(e.maxCol)?e.maxCol:v),ft=Math.max(1,e.minRow),et=Math.min(l-u.me.rowSpan+1,Number.isFinite(e.maxRow)?e.maxRow:l),p={...u.me,row:Math.max(ft,Math.min(et,u.me.row+it)),col:Math.max(rt,Math.min(ut,u.me.col+tt))},ot=new Map([[u.me.id,e]]);let o=[p,...u.others.map(n=>({...n}))];const d=JSON.parse(t.dataset.options);if(d.resolveCollisions)o=h(o,p,l,v,ot);else{const n=o.map(n=>n);if(!i(n,p)){const t=a(n,p,l,v);o=[t,...u.others.map(n=>({...n}))]}}d.floatMode&&(o=c(o,l,v));y=o;const w=n(p,u.m);u.clone.style.transform=`translate(${w.x}px,${w.y}px)`;u.placeholder.style.transform=`translate(${w.x}px,${w.y}px)`;for(const t of o){const i=u.base.find(n=>n.id===t.id);if(i){const r=n(i,u.m),f=n(t,u.m);t.el.style.transition="transform 70ms ease";t.el.style.transform=`translate(${f.x-r.x}px,${f.y-r.y}px)`}}}},w=()=>{function r(){o(t);u?.clone?.remove();u?.placeholder&&(u.placeholder.style.display="none");s=null;u=null;y=null}if(!u){s=null;return}const f=JSON.parse(t.dataset.options);let n=y||[];f.compactOnDrop&&(n=l(n,u.m.rows,u.m.cols));const e=n.map(n=>({id:n.id,row:n.row,column:n.col,rowSpan:n.rowSpan,colSpan:n.colSpan})),i=t._mudex?.dotnet;if(!i){r();return}i.invokeMethodAsync("MudEx_CommitLayout",e).then(()=>r())};r.addEventListener("pointerdown",b);r.addEventListener("pointermove",k);r.addEventListener("pointerup",w);r.addEventListener("pointercancel",w)},wireResize(t,r,u){const y=t.querySelector(".mud-ex-grid-overlay"),s=t.querySelector(".mud-ex-grid-placeholder"),[p,w,b]=u||[],v=(u,v)=>{if(u){let w=null,p=null,b=null;const d=i=>{const v=JSON.parse(r.dataset.options);if(v.resizable){i.stopPropagation();u.setPointerCapture(i.pointerId);w={x:i.clientX,y:i.clientY};const c=f(t),l=c.find(n=>n.el===r),b=c.filter(n=>n!==l),a=e(t);y.textContent="";const h=r.cloneNode(!0);h.classList.add("mud-ex-grid-clone");Object.assign(h.style,{position:"absolute",pointerEvents:"none",zIndex:30,left:0,top:0});y.appendChild(h);const o=n(l,a);Object.assign(h.style,{width:`${o.w}px`,height:`${o.h}px`,transform:`translate(${o.x}px,${o.y}px)`});s.style.display="block";Object.assign(s.style,{width:`${o.w}px`,height:`${o.h}px`,transform:`translate(${o.x}px,${o.y}px)`});p={base:c,me:l,others:b,m:a,clone:h,placeholder:s}}},g=u=>{if(w&&p){const e=JSON.parse(r.dataset.options),nt=u.clientX-w.x,tt=u.clientY-w.y,rt=v==="s"?0:Math.trunc((nt+Math.sign(nt)*.4*p.m.cw)/p.m.cw),ut=v==="e"?0:Math.trunc((tt+Math.sign(tt)*.4*p.m.ch)/p.m.ch),k=p.m.rows,d=p.m.cols;let o=p.me.colSpan+rt,l=p.me.rowSpan+ut;o=Math.max(e.minColSpan,Math.min(e.maxColSpan,o));l=Math.max(e.minRowSpan,Math.min(e.maxRowSpan,l));o=Math.min(o,d-p.me.col+1);l=Math.min(l,k-p.me.row+1);const y={...p.me,colSpan:o,rowSpan:l},ft=new Map([[p.me.id,e]]);let f=[y,...p.others.map(n=>({...n}))];const it=JSON.parse(t.dataset.options);if(it.resolveCollisions)f=h(f,y,k,d,ft);else{const n=f.map(n=>n);if(!i(n,y)){const t=a(n,y,k,d);f=[t,...p.others.map(n=>({...n}))]}}it.floatMode&&(f=c(f,k,d));b=f;const g=n(y,p.m);p.clone.style.width=`${g.w}px`;p.clone.style.height=`${g.h}px`;s.style.width=`${g.w}px`;s.style.height=`${g.h}px`;for(const t of f){const i=p.base.find(n=>n.id===t.id);if(i){const r=n(i,p.m),u=n(t,p.m);t.el.style.transition="transform 70ms ease";t.el.style.transform=`translate(${u.x-r.x}px,${u.y-r.y}px)`}}}},k=()=>{function r(){o(t);p?.clone?.remove();p.placeholder.style.display="none";w=null;p=null;b=null}if(!p){w=null;return}const u=JSON.parse(t.dataset.options);let n=b||[];u.compactOnDrop&&(n=l(n,p.m.rows,p.m.cols));const f=n.map(n=>({id:n.id,row:n.row,column:n.col,rowSpan:n.rowSpan,colSpan:n.colSpan})),i=t._mudex?.dotnet;if(!i){r();return}i.invokeMethodAsync("MudEx_CommitLayout",f).then(()=>r())};u&&typeof u.addEventListener=="function"&&(u.addEventListener("pointerdown",d),u.addEventListener("pointermove",g),u.addEventListener("pointerup",k),u.addEventListener("pointercancel",k))}};v(p,"e");v(w,"s");v(b,"se")}};