@page "/handle-file-as-streams"
@using MudBlazor.Extensions.Options
@inject IDialogService dialogService
@inject SampleDataService sampleDataService

@attribute [DemoNew(Group = "File Handling", Name = "File Display with Stream", Order = 0, Documentation = "The same sample as the other FileDisplay example with the esxception that no url is used and streams are loaded and used.", Icon = Icons.Material.Outlined.FolderZip, ForComponentTypes = new[] { typeof(MudExFileDisplay) })]

<DemoComponent PageType="@GetType()" CodeFiles="@(new [] {$"Pages/{GetType().Name}.razor", "Shared/MySimpleJsonDisplay.razor", "SampleDataService.cs"})">

    <MudExSelect T="SampleFileWithStream" ValuePresenter="ValuePresenter.ItemContent" HelperText="Select sample file (See weather.json to check how own components for files can be created)" ItemCollection="@_samples" Variant="Variant.Outlined" ToStringFunc="@(f => f.Name)" @bind-Value="SampleFile">
        <ItemTemplate>
            <div class="file-combo-item">
                <MudExIcon Color="@context.Color" Icon="@context.Icon"></MudExIcon>
                <MudText>@context.Name</MudText>
                <MudText Class="file-combo-info-item" Typo="Typo.subtitle2">@($"{context.ContentType} {context.ReadableSize}")</MudText>
            </div>
        </ItemTemplate>    
    </MudExSelect>

    @if (SampleFile?.Stream != null)
    {
        <div style="width: 100%; height: 800px; margin-top: 20px">
            <MudExFileDisplay HandleContentErrorFunc="@HandleContentError"
                              StreamUrlHandling="StreamUrlHandling.BlobUrl"
                              Dense="true"
                          FileName="@SampleFile.Name" ContentStream="@SampleFile.Stream" ContentType="@SampleFile.ContentType"></MudExFileDisplay>
        </div>
        <MudButton OnClick="@OpenAsDialog" Variant="Variant.Filled" Color="Color.Primary">Show As Dialog</MudButton>
    }
</DemoComponent>


@code {

    private List<SampleFileWithStream> _samples = new ();

    protected override async Task OnInitializedAsync()
    {
        _samples.AddRange(await sampleDataService.GetSampleFilesWithStreamAsync());
    }

    private string url;
    private async Task OpenAsDialog()
    {
        var parameters = new DialogParameters {
            { nameof(MudExFileDisplay.StreamUrlHandling), StreamUrlHandling.BlobUrl },
            { nameof(MudExFileDisplay.Dense), true }
        };
        await dialogService.ShowFileDisplayDialog(SampleFile.Stream, SampleFile.Name, SampleFile.ContentType, HandleContentError, null, parameters);
    }

    private Task<MudExFileDisplayContentErrorResult> HandleContentError(IMudExFileDisplayInfos arg)
    {
        if (arg.ContentType.Contains("word"))
        {
            return Task.FromResult(MudExFileDisplayContentErrorResult
                .RedirectTo("https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTiZiqnBKWS8NHcKbRH04UkYjrCgxUMz6sVNw&usqp=CAU", "image/png")
                .WithMessage("No word plugin found we display a sheep"));
        }
        return Task.FromResult(MudExFileDisplayContentErrorResult.Unhandled);
    }

    public SampleFileWithStream SampleFile { get; set; }
}