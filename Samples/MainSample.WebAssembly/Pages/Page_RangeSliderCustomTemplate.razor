@page "/range-slider-template"
@inherits BasePage

@using System.Globalization
@using MudBlazor.Extensions.Helper
@using Nextended.Core.Contracts
@using Nextended.Core.Types

@attribute [DemoNew(Name = "MudExRangeSlider Template", Group="RangeSlider", Documentation = "Custom Templates", ForComponentTypes = new[] { typeof(MudExRangeSlider<>) })]



<MudExRangeSlider @bind-Value="dateRange"
                  SizeRange="fullRange"
                  StepLength="monthStep"
                  StepResolver="MonthStepResolver"
                  ShowInputs="false">

    <TrackTemplate Context="ctx">
        <div style="height: 100%;
                    position: relative;
                    width: 100%;
                    background: #f5f5f5;
                    border-radius: 4px;
                    overflow: hidden;">

            @* Jahresmarkierungen (dick, volle Höhe) mit Jahreszahl *@
            @for (int year = startYear; year <= endYear; year++)
            {
                var yearStart = new DateTime(year, 1, 1);
                var pctStart = GetPercentStatic(yearStart, ctx.SizeRange) * 100;

                // Berechne die Mitte des Jahres für die Jahreszahl
                var yearMid = new DateTime(year, 7, 1);
                var pctMid = GetPercentStatic(yearMid, ctx.SizeRange) * 100;

                <div style="position: absolute;
                                    left: @(pctStart.ToString("F2", System.Globalization.CultureInfo.InvariantCulture))%;
                                    top: 0;
                                    bottom: 0;
                                    width: 2px;
                                    background: #999;">
                </div>

                @* Jahreszahl in der Mitte des Jahres *@
                <div style="position: absolute;
                                    left: @(pctMid.ToString("F2", System.Globalization.CultureInfo.InvariantCulture))%;
                                    top: 50%;
                                    transform: translate(-50%, -50%);
                                    font-size: 11px;
                                    color: #666;
                                    font-weight: 600;
                                    pointer-events: none;
                                    white-space: nowrap;
                                    z-index: 0;">
                    @year
                </div>
            }

            @* Monatsmarkierungen (dünn, mit Margin) *@
            @for (var date = new DateTime(startYear, 1, 1); date <= new DateTime(endYear, 12, 1); date = date.AddMonths(1))
            {
                if (date.Month != 1) // Skip January (already marked by year)
                {
                    var pct = GetPercentStatic(date, ctx.SizeRange) * 100;

                    <div style="position: absolute;
                                                left: @(pct.ToString("F2", System.Globalization.CultureInfo.InvariantCulture))%;
                                                top: 15%;
                                                bottom: 15%;
                                                width: 1px;
                                                background: #ccc;">
                    </div>
                }
            }
        </div>
    </TrackTemplate>

    <SelectionTemplate Context="ctx">
        <div style="height: 100%;
                    width: 100%;
                    background: #1976d2;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    position: relative;
                    border-radius: 4px;">
            <span style="color: white;
                         font-weight: 600;
                         font-size: 11px;
                         white-space: nowrap;
                         padding: 0 8px;
                         text-shadow: 0 1px 2px rgba(0,0,0,0.2);">
                @GetDateString(ctx.Value.Start) - @GetDateString(ctx.Value.End)
            </span>
        </div>
    </SelectionTemplate>

    <ThumbStartTemplate Context="ctx">
        <div style="width: 14px;
                    height: 14px;
                    background: white;
                    border: 3px solid #1976d2;
                    border-radius: 50%;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
        </div>
    </ThumbStartTemplate>

    <ThumbEndTemplate Context="ctx">
        <div style="width: 14px;
                    height: 14px;
                    background: white;
                    border: 3px solid #1976d2;
                    border-radius: 50%;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
        </div>
    </ThumbEndTemplate>

</MudExRangeSlider>

@code {
    private int startYear = 2015;
    private int endYear = 2022;

    private IRange<DateTime> dateRange = new MudExRange<DateTime>(
        new DateTime(2016, 1, 1),
        new DateTime(2016, 12, 31)
    );

    private IRange<DateTime> fullRange => new MudExRange<DateTime>(
        new DateTime(startYear, 1, 1),
        new DateTime(endYear, 12, 31)
    );

    private RangeLength<DateTime> monthStep = new RangeLength<DateTime>(TimeSpan.FromDays(30).Ticks);

    // Custom Step Resolver - snappt immer auf den 1. des Monats
    private DateTime MonthStepResolver(
        DateTime value,
        IRange<DateTime> sizeRange,
        RangeLength<DateTime> stepLength,
        int steps,
        SnapPolicy policy)
    {
        if (steps != 0)
        {
            // Wenn steps angegeben: Monate addieren
            var current = new DateTime(value.Year, value.Month, 1);
            var result = current.AddMonths(steps);

            // Clamp auf SizeRange
            if (result < sizeRange.Start) return sizeRange.Start;
            if (result > sizeRange.End) return sizeRange.End;
            return result;
        }
        else
        {
            // Snapping: Immer auf den 1. des Monats
            var snapped = new DateTime(value.Year, value.Month, 1);

            // Wenn nach dem 15. des Monats und policy ist Nearest, zum nächsten Monat
            if (policy == SnapPolicy.Nearest && value.Day > 15)
            {
                snapped = snapped.AddMonths(1);
            }
            else if (policy == SnapPolicy.Ceiling && value.Day > 1)
            {
                snapped = snapped.AddMonths(1);
            }
            // SnapPolicy.Down bleibt beim aktuellen Monatsanfang

            // Clamp auf SizeRange
            if (snapped < sizeRange.Start) return sizeRange.Start;
            if (snapped > sizeRange.End) return sizeRange.End;
            return snapped;
        }
    }

    // Statische Methode die den Context benutzt
    private static double GetPercentStatic(DateTime date, IRange<DateTime> range)
    {
        var totalTicks = (range.End - range.Start).Ticks;
        var currentTicks = (date - range.Start).Ticks;
        return (double)currentTicks / totalTicks;
    }

    private string GetDateString(DateTime date)
    {
        return date.ToString("MMM yyyy", CultureInfo.CurrentCulture);
    }
}